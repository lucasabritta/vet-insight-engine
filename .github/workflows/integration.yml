name: Integration Test

on:
  push:
    branches: [master]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration:
    name: Docker Compose Integration Test
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start services with docker-compose
        run: |
          docker compose up -d --build

      - name: Wait for backend health
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:8000/health >/dev/null 2>&1; then
              echo "✓ Backend is healthy"
              exit 0
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
          echo "✗ Backend failed to become healthy" >&2
          docker compose logs
          exit 1

      - name: Check backend endpoints
        run: |
          echo "Testing GET /health"
          status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health)
          test "$status" = "200" || { echo "Health check failed with status $status"; exit 1; }
          echo "✓ Health endpoint working"

      - name: Wait for frontend
        run: |
          for i in $(seq 1 20); do
            if curl -sf http://localhost:5173/ >/dev/null 2>&1; then
              echo "✓ Frontend is responding"
              exit 0
            fi
            echo "Waiting for frontend... ($i/20)"
            sleep 2
          done
          echo "✗ Frontend failed to respond" >&2
          exit 1

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== Backend logs ==="
          docker compose logs backend || true
          echo "=== Frontend logs ==="
          docker compose logs frontend || true
          echo "=== Postgres logs ==="
          docker compose logs postgres || true

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
